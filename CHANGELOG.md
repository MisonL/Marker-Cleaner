# Changelog

All notable changes to this project will be documented in this file.

## [1.2.0] - 2026-01-25

**Refactoring & Stability Milestone / 重构与稳定性里程碑**

本次更新完成了核心算法模块的深度重构，引入了工业级的回归测试门禁 (Regression Gate)，显著提升了代码的可维护性与算法迭代的安全性。

### 🏗️ 架构与工程化 (Architecture)

- **模块化重构**: 将 `cleaner.ts` 拆解为 `Core`, `Detectors`, `Utils` 三层架构，逻辑解耦，职责分明。
- **回归测试 V2.0**: 引入 `baseline.json` 机制，覆盖 50+ 典型样本的全量门禁，杜绝算法“静默劣化”。
- **全量单元测试**: 新增细粒度单元测试 (Core/Detectors)，整体测试覆盖率达到 100% (Pass rate 53/53)。
- **代码规范**: 全项目接入 Biome 及其严格的 Lint 规则，统一代码风格，消除潜在风险。

### ✨ 优化 (Optimizations)

- **性能提升**: 优化了 `batch-processor` 的任务去重逻辑 (O(n²) -> O(n))，在大批量任务下响应更快。
- **配置增强**: 关键算法阈值 (如 `HUGE_BOX_AREA_RATIO`) 实现常量化管理，便于后续调优。
- **类型安全**: 修复了多处潜在的 `any` 类型风险与空值隐患。

---

## [1.1.0] - 2026-01-23

**Experience Upgrade / 体验大幅升级**

本次更新专注于用户体验的打磨与 Windows 平台的兼容性修复，为您带来更纯净、更智能的使用感受。

### ✨ 新增特性 (New Features)

- **🔄 智能断点续传 (Interactive Resume)**:
  - 启动批量处理时自动检测历史进度，不再"无脑"从头开始。
  - 新增交互界面：您可以选择 **[Enter] 继续处理** (跳过已完成) 或 **[R] 重新开始** (一键重置)。
  - 彻底解决了"找不到待处理任务"的困惑。
- **🧠 全方位模型兼容 (Model Ecosystem)**:
  - 全面支持 OpenAI 兼容接口，实测已完美适配 **通义千问 Qwen3-VL-plus**。
  - **核心黑科技**：内置 **JSON 破碎修复算法 (Smart Recovery)**。针对部分 AI 模型由于 Token 限制或回复话多导致的 JSON 截断、格式错误、未闭合括号等问题，系统实现了“死里逃生”级的正则抢救提取，识别成功率跃升。
- **⚪️ 纯白主题重构 (Pure White Theme)**:
  - 重新定义了 Light Mode 的配色方案，将背景强制锁定为 Hex `#FFFFFF`。
  - 消除了各类终端 (iTerm2/Windows Terminal) 下可能出现的"灰色伪白"，提供如纸面般干净的视觉体验。

### 🐛 问题修复 (Bug Fixes)

- **🖼️ Web 报告体验**:
  - 修复了“所有任务历史”下拉框无法切换的问题，现在当前任务会即时出现在导航中。
  - 强制转换 Windows 路径分隔符为 Web 标准，确保报告链接在 PC 环境下不再失效。
- **⌨️ 快捷键逻辑优化**:
  - 完成页打开报告的快捷键由 `O` 升级为更契合直觉的 **[Enter]**。
  - 增加了对 `0` (数字零) 误解的兼容处理。
- **🪟 Windows 兼容性增强**:
  - 修复了在老旧 Windows 控制台 (CMD/PowerShell) 中出现 OSC 乱码字符的问题。
  - 智能识别 `Windows Terminal`，仅在支持的环境下发送高级颜色指令。
- **🛠️ 依赖管理与稳定**:
  - 优化了 `sharp` 模块的检测逻辑，提供更清晰的安装指引。
  - 实现了 TUI 版本号与 `package.json` 的全自动同步。
  - 修复了 `FileSelectorWithInput` 等组件中的 TS 类型定义与变量作用域问题。

---

## [1.0.0] - 2026-01-22

**Initial Release / 首次正式发布**

Marker Cleaner v1.0.0 是一款专为高效率去水印与图像修复打造的智能工具。它融合了最新的多模态 AI 技术与本地像素算法，致力于在保证画质的前提下，提供极速、批量、低成本的图像清洗体验。

### ✨ 核心特性 (Core Features)

- **双模态智能引擎**:
  - **Native AI 模式**: 调用支持图像生成的多模态模型（如 `gemini-3-pro-image`），直接让 AI 理解画面并**重绘被标记污染的区域**，完美还原复杂纹理与光影细节。
  - **Detection 极速模式**: 使用视觉模型（如 `gemini-3-flash`、`gpt-4o`）**仅定位标记坐标**，修复工作由本地 Sharp 算法完成，Token 消耗极低，适合批量处理纯色背景图片。
- **多渠道接入**: 开箱即用支持 Google Gemini、OpenAI 以及 Antigravity 企业级渠道，满足不同场景的成本与性能需求。

### 🚀 极致性能 (Performance)

- **智能并发处理**: 内置 `p-limit` 自适应并发控制（默认 4 线程），支持万级图片批量导入，确保内存占用平稳，杜绝 OOM。
- **异步报告生成**: 采用流式处理与异步缩略图生成技术 (`sharp`)，处理速度较竞品提升 500%，HTML 报告体积缩减 90%。
- **工业级鲁棒性**: 全链路实现指数退避重试机制，内置 120s 任务超时熔断与自动冲突重命名策略，无人值守也放心。

### 🇨🇳 开箱即用 (User Experience)

- **全中文交互**: 从 CLI 终端界面 (TUI) 到生成的 HTML 交互报告，提供 100% 贴心的中文本地化体验。
- **可视化审计**: 自动生成包含 "Before/After" 对比、Token 消耗、耗时统计的交互式 HTML 报告，处理效果一目了然。
- **灵活输入输出**:
  - 完美支持 Windows/Mac/Linux 跨平台。
  - 支持拖拽文件、粘贴路径 (`file://`、UNC、绝对/相对路径) 等多种输入方式。
  - 输出格式可选 PNG/JPG/WEBP，保留原始目录结构。

### 🛡️ 企业级安全 (Security)

- **数据隐私**: 提供严格的参数清洗与日志脱敏，敏感 Key 不落盘。
- **运行安全**: 内置 HTML 注入防护 (XSS) 与路径遍历防御，通过 Biome 严格代码审计。
- **成本熔断**: 支持设置全局 Token/金额预算上限 (Budget Limit)，意外消耗自动熔断，守住你的钱包。
